image: buildstream/buildstream-fedora:master-51-9632eaf

variables:
  # Store all the bst stuff under the "${CI_PROJECT_DIR}" directory.
  # Note that GitLab CI will only cache stuff inside the "${CI_PROJECT_DIR}" folder.
  XDG_CACHE_HOME: "${CI_PROJECT_DIR}/cache"
  GET_SOURCES_ATTEMPTS: 3
  BST_LOGS: "${CI_PROJECT_DIR}/logs"
  BST: "bst --config ${CI_PROJECT_DIR}/build.conf --log-file ${CI_PROJECT_DIR}/logs/build.log --colors"
  BST_SHA: '06ae434a7017edbf67bf46c3fe2e327466801787' #  1.1.3

stages:
  - build


# Store all the downloaded git and ostree repos in the cache.
# This saves us fetching them on every build
cache:
  key: bst
  paths:
    - "${XDG_CACHE_HOME}/buildstream/sources/"


before_script:
  # Remove any installed buildstream binary
  - pip3 uninstall -y buildstream

  # Use specific version of BuildStream
  - git clone https://gitlab.com/BuildStream/buildstream.git
  - git -C buildstream/ checkout $BST_SHA
  - pip3 install buildstream/

  # Generate a build.conf which configures the build
  - |
    cat > ${CI_PROJECT_DIR}/build.conf << EOF

    # The log directory
    logdir: ${BST_LOGS}

    # Keep building and find all the errors
    scheduler:
      on-error: continue

    # Get a lot of output in case of errors
    logging:
      error-lines: 80

    EOF

bst-build-gnome-core:
  stage: build
  dependencies: []
  tags:
    - do
  script:
    - echo "${BST}"
    - ${BST} build --track-all core.bst
  # Store all the downloaded git and ostree repos in the distributed cache.
  # This saves us fetching them from the different repos and further afield
  # on every build.
  cache:
    key: bst
    paths:
      - "${XDG_CACHE_HOME}/buildstream/sources/"
  # Store artifacts so we can inspect build failures
  artifacts:
    when: always
    paths:
      - ${BST_LOGS}
