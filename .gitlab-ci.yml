variables:
  # Store all the bst stuff under the "${CI_PROJECT_DIR}" directory.
  # Note that GitLab CI will only cache stuff inside the "${CI_PROJECT_DIR}" folder.
  XDG_CACHE_HOME: "${CI_PROJECT_DIR}/cache"
  GET_SOURCES_ATTEMPTS: 3
  BST: 'bst'
  BST_SHA: 'bc5a40e3dccbe1cb8066171fc2c0a4a5abeaa31e' #  1.1.3-177-gbc5a40e3
  BST_EXTERNAL_SHA: 'cf53cff64f4a6b3b3e2f0ac7ec13290511e9a137' # 0.2
  FLATPAK_BRANCH: next

stages:
  - build


# Store all the downloaded git and ostree repos in the cache.
# This saves us fetching them on every build
cache:
  key: bst
  paths:
    - "${XDG_CACHE_HOME}/buildstream/sources/"


before_script:
  # Remove any installed buildstream binary
  - pip3 uninstall -y buildstream
  # Use specific version of BuildStream
  - git clone https://gitlab.com/BuildStream/buildstream.git
  - git -C buildstream/ checkout $BST_SHA
  - pip3 install buildstream/
  # install bst-external nedded for the flatpak_image plugin
  - git clone https://gitlab.com/BuildStream/bst-external.git
  - git -C bst-external/ checkout $BST_EXTERNAL_SHA
  - pip3 install bst-external/
  # for the flatpak runtimes
  - dnf install -y flatpak

.build-template: &build
  stage: build
  dependencies: []
  script:
    - ${BST} build --track-all core.bst flatpak-runtimes.bst
    - |
      mkdir runtimes

      for runtime in platform platform-locale sdk sdk-debug sdk-docs sdk-locale; do
        bst checkout "flatpak/${runtime}.bst" "runtimes/${runtime}";
        flatpak build-export --files=files repo/ runtimes/${runtime} ${FLATPAK_BRANCH};
      done
    - |
      for runtime in org.gnome.Platform org.gnome.Platform.Locale org.gnome.Sdk org.gnome.Sdk.Debug org.gnome.Sdk.Docs org.gnome.Sdk.Locale; do
        flatpak build-bundle --runtime repo/ flatpak-bundles/$runtime.flatpak $runtime next
      done

  # Store all the downloaded git and ostree repos in the distributed cache.
  # This saves us fetching them from the different repos and further afield
  # on every build.
  cache:
    key: bst
    paths:
      - "${XDG_CACHE_HOME}/buildstream/sources/"
  # Store artifacts so we can inspect build failures
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/cache/buildstream/logs
      - ${CI_PROJECT_DIR}/flatpak-bundles/

build-gnome-core-x86_64:
  image: buildstream/buildstream-fedora:master-51-9632eaf
  tags:
    - do
  <<: *build

# https://gitlab.gnome.org/Infrastructure/GitLab/issues/295
#build-gnome-core-aarch64:
#  image: buildstream/buildstream-fedora:aarch64-master-79-c1c09e3
#  tags:
#    - aarch64
#  <<: *build
