include: .gitlab-ci/arch.yml

variables:
  GET_SOURCES_ATTEMPTS: 3
  BST_STRICT: '--strict'
  BST_TRACK_TAGS: 'false'
  BST_NO_PUSH: "bst $BST_STRICT --config .gitlab-ci/buildstream-nopush.conf --log-file logs/build.log --colors"
  BST: "bst $BST_STRICT --config .gitlab-ci/buildstream.conf --log-file logs/build.log --colors"
  FLATPAK_BRANCH: '43'
  OPENQA_HOST: https://openqa.gnome.org
  OPENQA_NEEDLES_GIT: https://gitlab.gnome.org/gnome/openqa-needles
  OPENQA_NEEDLES_SHA: master

  # Docker Images
  DOCKER_REGISTRY: "registry.gitlab.com/freedesktop-sdk/infrastructure/freedesktop-sdk-docker-images"
  DOCKER_IMAGE_ID: "3bee7d7876bc776cdf8379ab0713fcd405ac5002"

stages:
- deploy

default:
  image: "${DOCKER_REGISTRY}/bst16:${DOCKER_IMAGE_ID}"
  before_script:
  # Ensure the log directory exists
  - mkdir -p logs

  # Setup certificate for pushing to the cache
  - echo "$CASD_CLIENT_CERT" > client.crt
  - echo "$CASD_CLIENT_KEY" > client.key

#
# Templates shared by multiple jobs
#

.image-template:
  stage: deploy
  when: always
  allow_failure: true
  script:
  - ${BST_NO_PUSH} --max-jobs $(( $(nproc) / 4 )) -o arch "${ARCH}" build "${IMAGE}"
  - ${BST} -o arch "${ARCH}" checkout --hardlinks "${IMAGE}" image
  artifacts:
    when: always
    paths:
    - image
    expire_in: '2 days'

#
# "Real" CI jobs
#

pinephone-pro-image:
  extends:
  - .image-template
  - .aarch64
  variables:
    IMAGE: boards/pinephone-pro/image.bst
