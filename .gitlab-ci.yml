variables:
  # Store all the bst stuff under the "${CI_PROJECT_DIR}" directory.
  # Note that GitLab CI will only cache stuff inside the "${CI_PROJECT_DIR}" folder.
  XDG_CACHE_HOME: "${CI_PROJECT_DIR}/cache"
  GET_SOURCES_ATTEMPTS: 3
  BST: "bst --config build.conf --log-file logs/build.log --colors"
  BST_SHA: "10abe77fe8d77385d86f225b503d9185f4ef7f3a" #  1.2.3
  BST_EXTERNAL_SHA: 'ab9b37b5b52a7b2f62ddf17a68b76512da538291' # 0.5.0
  FLATPAK_BRANCH: master

  GNOME_SERVER_BASTION: 'bastion.gnome.org'
  GNOME_SERVER_GBM_BUILDER: 'vpn.gbm-builder.gnome.org'

stages:
  - track
  - build
  - flatpak


# Store all the downloaded git and ostree repos in the cache.
# This saves us fetching them on every build
cache:
  key: bst
  paths:
    - "${XDG_CACHE_HOME}/buildstream/sources/"


before_script:
  # Remove any installed buildstream binary
  - pip3 uninstall -y buildstream

  # Use specific version of BuildStream
  - git clone https://gitlab.com/BuildStream/buildstream.git
  - git -C buildstream/ checkout $BST_SHA
  - pip3 install buildstream/

  # install bst-external nedded for the flatpak_image plugin
  - git clone https://gitlab.com/BuildStream/bst-external.git
  - git -C bst-external/ checkout $BST_EXTERNAL_SHA
  - pip3 install bst-external/

  # flatpak and rsync to generate and transfer the flatpak runtimes
  - dnf install -y flatpak rsync

  # Ensure the log directory exists
  - mkdir -p logs

  # Setup certificate for pushing to the cache
  - |
    if [ -n "$GITLAB_CAS_PUSH_CERT" ]; then
       echo "$GITLAB_CAS_PUSH_CERT" > client.crt
       echo "$GITLAB_CAS_PUSH_KEY" > client.key
    fi

    cat >> build.conf << EOF

    projects:
      gnome:
        artifacts:
          url: https://cache.gitlab.gnome.org:11002
          client-key: client.key
          client-cert: client.crt
          push: true
    EOF

  # and ssh key for pushing to the flatpak repo
  - |
    if [ -n "$GITLAB_SSH_KEY" ]; then
        mkdir -p ~/.ssh

        echo "$GITLAB_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        cat >> ~/.ssh/config << EOF
    Host gbm-builder.gnome.org
        User gbm
        ProxyJump bastion.gnome.org
        Hostname vpn.gbm-builder.gnome.org

    Host bastion.gnome.org
        User gbm
    EOF

        # Trust the host key of the jump host and release server
        ssh-keyscan "${GNOME_SERVER_BASTION}" >> ~/.ssh/known_hosts
        ssh-keyscan "${GNOME_SERVER_GBM_BUILDER}" >> ~/.ssh/known_hosts

    fi

.cache-template: &cache
  # Store all the downloaded sources in the distributed cache. This saves
  # us fetching them from the different repos and further afield
  # on every build.
  cache:
    key: bst
    paths:
      - "${XDG_CACHE_HOME}/buildstream/sources/"

.build-template: &build
  stage: build
  script:
    - ${BST} -o arch "${ARCH}" build core.bst flatpak-runtimes.bst
  <<: *cache
  # Store artifacts so we can inspect build failures
  artifacts:
    when: always
    paths:
      - logs
      - project.refs

.flatpak-template: &flatpak
  stage: flatpak
  script:
    - ${BST} -o arch "${ARCH}" build flatpak-runtimes.bst

    # checkout the runtimes
    - |
      for runtime in platform platform-locale sdk sdk-debug sdk-docs sdk-locale; do
        bst -o arch "${ARCH}" checkout --hardlinks "flatpak/${runtime}.bst" "runtimes/${runtime}"
        flatpak build-export --arch="${ARCH}" --no-update-summary --files=files repo/ "runtimes/${runtime}" "${FLATPAK_BRANCH}"
      done

    - BRANCHES=$(find repo/refs/heads/ -type f | grep "${ARCH}/${FLATPAK_BRANCH}" | sed s,repo/refs/heads/,,)

    # Push the resulting runtimes to gbm.gnome.org
    # Assume there will be no branch name collisions,
    # the ssh key is available only on protected branches
    - |
      if [ -n "$GITLAB_SSH_KEY" ]; then
        if [ "$FLATPAK_BRANCH" = master ]; then
          CONFIG_FILE=config/nightly.json
        else
          CONFIG_FILE=config/stable.json
        fi

        rsync -a repo/ gbm-builder.gnome.org:incoming/repo-${CI_JOB_ID}
        ssh gbm-builder.gnome.org gbm-flatpak-scripts/import-commits -c "${CONFIG_FILE}" incoming/repo-${CI_JOB_ID} ${BRANCHES}
      fi

  <<: *cache
  # Store artifacts so we can inspect build failures
  artifacts:
    when: always
    paths:
      - logs
      - project.refs


track:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  stage: track
  script:
    - ${BST} track --deps all core.bst flatpak-runtimes.bst

  <<: *cache
  # don't run on stable branches
  except:
    - /^gnome-\d-\d\d$/
  artifacts:
    when: always
    paths:
      - logs
      - project.refs


build-gnome-core-x86_64:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *build
  tags:
    - do
  variables:
    ARCH: x86_64

build-gnome-core-i386:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *build
  tags:
    - do
  variables:
    ARCH: i386
  allow_failure: true

build-gnome-core-aarch64:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *build
  tags:
    - aarch64
  variables:
    ARCH: aarch64
  allow_failure: true

build-gnome-core-arm:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *build
  tags:
    - armhf
  variables:
    ARCH: arm
  allow_failure: true

flatpak-x86_64:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *flatpak
  tags:
    - do
  variables:
    ARCH: x86_64

flatpak-i386:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *flatpak
  tags:
    - do
  variables:
    ARCH: i386

flatpak-aarch64:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *flatpak
  tags:
    - aarch64
  variables:
    ARCH: aarch64

flatpak-arm:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *flatpak
  tags:
    - armhf
  variables:
    ARCH: arm
