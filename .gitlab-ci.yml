variables:
  # Store all the bst stuff under the "${CI_PROJECT_DIR}" directory.
  # Note that GitLab CI will only cache stuff inside the "${CI_PROJECT_DIR}" folder.
  XDG_CACHE_HOME: "${CI_PROJECT_DIR}/cache"
  GET_SOURCES_ATTEMPTS: 3
  BST: "bst --config build.conf --log-file logs/build.log --colors"
  BST_SHA: '970c6696f2eef0bde282f82eb95ae4708ccbf308' #  1.1.6

stages:
  - build


# Store all the downloaded git and ostree repos in the cache.
# This saves us fetching them on every build
cache:
  key: bst
  paths:
    - "${XDG_CACHE_HOME}/buildstream/sources/"


before_script:
  # Remove any installed buildstream binary
  - pip3 uninstall -y buildstream

  # Use specific version of BuildStream
  - git clone https://gitlab.com/BuildStream/buildstream.git
  - git -C buildstream/ checkout $BST_SHA
  - pip3 install buildstream/

  # Ensure the log directory exists
  - mkdir -p logs

  # Setup certificate for pushing to the cache
  - |
    if [ -n "$GITLAB_CAS_PUSH_CERT" ]; then
       echo "$GITLAB_CAS_PUSH_CERT" > client.crt
       echo "$GITLAB_CAS_PUSH_KEY" > client.key
    fi

    cat >> build.conf << EOF

    projects:
      gnome:
        artifacts:
          url: https://cache.gitlab.gnome.org:11002
          client-key: client.key
          client-cert: client.crt
          push: true
    EOF

.build-template: &build
  stage: build
  dependencies: []
  script:
    - ${BST} -o arch "${ARCH}" build --track-all core.bst
  # Store all the downloaded git and ostree repos in the distributed cache.
  # This saves us fetching them from the different repos and further afield
  # on every build.
  cache:
    key: bst
    paths:
      - "${XDG_CACHE_HOME}/buildstream/sources/"
  # Store artifacts so we can inspect build failures
  artifacts:
    when: always
    paths:
      - logs
      - project.refs

build-gnome-core-x86_64:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *build
  tags:
    - do
  variables:
    ARCH: x86_64

build-gnome-core-i686:
  image: buildstream/buildstream-fedora:master-113-499df6a5
  <<: *build
  tags:
    - do
  variables:
    ARCH: i686

build-gnome-core-aarch64:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *build
  tags:
    - aarch64
  variables:
    ARCH: aarch64
  allow_failure: true

build-gnome-core-arm:
  image: buildstream/buildstream-fedora:aarch64-master-113-499df6a5
  <<: *build
  tags:
    - aarch64
  variables:
    ARCH: arm
  allow_failure: true
