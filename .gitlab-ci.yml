variables:
  OPENQA_HOST: https://openqa.gnome.org
  OPENQA_TESTS_GIT: https://gitlab.gnome.org/gnome/openqa-tests
  OPENQA_TESTS_BRANCH: master
  OPENQA_NEEDLES_GIT: https://gitlab.gnome.org/gnome/openqa-needles
  OPENQA_NEEDLES_BRANCH: master
  S3_ISO_IMAGE_URL: https://os.gnome.org/download/latest/gnome_os_installer.iso
  S3_DISK_IMAGE_URL: https://os.gnome.org/download/latest/gnome_os_disk.img.xz

stages:
- test

test-s3-image-x86_64:
  stage: test
  image:
    name: registry.opensuse.org/devel/openqa/containers15.4/openqa_worker:latest
    entrypoint: ["/bin/bash", "-c"]
  variables:
    # CI needs to be set so OPENQA_TEST_TIMEOUT_SCALE_CI has an effect.
    CI: 1
    OPENQA_TEST_TIMEOUT_SCALE_CI: 4
  before_script:
  # FIXME: this is a slowdown and causes excess data usage.
  # Can be removed once container image is updated with https://github.com/os-autoinst/openQA/pull/5116
  #
  # Ignore exit code as it seems to return non-zero on success.
  - |
    zypper install -y xz || true
  - |
    echo "Fetching test media"
    utils/fetch_test_media.sh $S3_ISO_IMAGE_URL /data/factory/iso/installer.iso
    utils/fetch_test_media.sh $S3_DISK_IMAGE_URL /data/factory/hdd/disk.img.xz
    unxz /data/factory/hdd/disk.img.xz
  - |
    echo "Calculating checksums of test media"
    sha256sum /data/factory/iso/installer.iso /data/factory/hdd/disk.img
  - |
    disk_size_gb=10
    echo "Expanding disk image to ${disk_size_gb}GB"
    dd if=/dev/zero of=/data/factory/hdd/disk.img seek=$disk_size_gb obs=1GB count=0
  script:
  - |
    rm /etc/openqa/*
    cat >/etc/openqa/client.conf <<EOF
    [openqa.gnome.org]
    key = $OPENQA_API_KEY
    secret = $OPENQA_API_SECRET
    EOF
  - |
    worker_class=qemu_x86_64-${CI_JOB_ID}
    utils/setup_worker.sh ${worker_class}
    /run_openqa_worker.sh &> worker.log &
  - |
    version="master"
    casedir="$(pwd)"
    utils/start_all_jobs.sh "${worker_class}" "${version}" "${casedir}" > /tmp/job_ids
  - |
    echo "Test jobs have been started. To see progress, visit:"
    for job_id in $(cat /tmp/job_ids); do
      echo "  * $OPENQA_HOST/tests/$job_id"
    done
  - utils/wait_for_job.sh $(cat /tmp/job_ids) > /tmp/exit_code
  - exit $(cat /tmp/exit_code)
  after_script:
  - |
    if [ ! -e /tmp/exit_code ]; then
        echo "Job creation failed, log below."
        cat openqa.log
  - fi
  artifacts:
    when: always
    paths:
    - openqa.log
    - worker.log
    expire_in: '1 week'
  tags:
  - x86_64
  - gnome-build-meta
