
include: .gitlab-ci/arch.yml

stages:
- deploy

default:
  image: "${DOCKER_REGISTRY}/bst16:${DOCKER_IMAGE_ID}"
  before_script:
  # Ensure the log directory exists
  - mkdir -p logs

  # Setup certificate for pushing to the cache
  - echo "$CASD_CLIENT_CERT" > client.crt
  - echo "$CASD_CLIENT_KEY" > client.key

flatmgr:
  extends:
  - .arch-indep
  stage: deploy
  script:
  - TARGETS_REPO=TARGETS_${FLAT_MANAGER_REPO}
  - TARGETS="$TARGETS ${!TARGETS_REPO}"

  - ostree init --repo repo/ --mode archive
  - |
    for ARCH in $SUPPORTED_ARCHES; do
      $BST -o arch $ARCH pull $TARGETS

      for target in $TARGETS; do
        $BST -o arch $ARCH checkout --hardlinks $target checkout-repo/
        ostree pull-local --repo repo/ checkout-repo/
        rm -rf checkout-repo/
      done
    done
  - ostree fsck --repo repo/ --all
  - flatpak build-update-repo --generate-static-deltas repo/

  - flat-manager-client create $FLAT_MANAGER_SERVER $FLAT_MANAGER_REPO > build.txt
  - flat-manager-client push $(cat build.txt) repo/
  - flat-manager-client commit --wait $(cat build.txt)
  - flat-manager-client publish --wait $(cat build.txt)
  after_script:
  - flat-manager-client purge $(cat build.txt)
  environment:
    name: $ENVIRONMENT_NAME
