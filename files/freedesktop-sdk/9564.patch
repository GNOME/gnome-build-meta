From b3d8d828c93b873bd8d830da1ae3edd90d39aff9 Mon Sep 17 00:00:00 2001
From: Jordan Petridis <jordan@centricular.com>
Date: Wed, 17 Aug 2022 13:29:21 +0300
Subject: [PATCH] wireplumber: fix alsa enumeration

https://gitlab.freedesktop.org/pipewire/wireplumber/-/issues/303


(cherry picked from commit 113eff31bbda2f2c9a88f424adea7901cb48eb81)
---
 elements/components/wireplumber.bst           |  2 +
 ...637c329bc9dda8544b18f5bd47a8d63ee253.patch | 39 +++++++++++++++++++
 2 files changed, 41 insertions(+)
 create mode 100644 files/wireplumber/c16e637c329bc9dda8544b18f5bd47a8d63ee253.patch

diff --git a/elements/components/wireplumber.bst b/elements/components/wireplumber.bst
index e35e7b2f43..e8230f8950 100644
--- a/elements/components/wireplumber.bst
+++ b/elements/components/wireplumber.bst
@@ -32,3 +32,5 @@ sources:
   directory: subprojects/cpptoml
   track: master
   ref: v0.1.1-0-gfededad7169e538ca47e11a9ee9251bc361a9a65
+- kind: patch
+  path: files/wireplumber/c16e637c329bc9dda8544b18f5bd47a8d63ee253.patch
diff --git a/files/wireplumber/c16e637c329bc9dda8544b18f5bd47a8d63ee253.patch b/files/wireplumber/c16e637c329bc9dda8544b18f5bd47a8d63ee253.patch
new file mode 100644
index 0000000000..b4ec563003
--- /dev/null
+++ b/files/wireplumber/c16e637c329bc9dda8544b18f5bd47a8d63ee253.patch
@@ -0,0 +1,39 @@
+From c16e637c329bc9dda8544b18f5bd47a8d63ee253 Mon Sep 17 00:00:00 2001
+From: George Kiagiadakis <george.kiagiadakis@collabora.com>
+Date: Thu, 7 Jul 2022 20:58:36 +0300
+Subject: [PATCH] alsa: use "obj_type" as a variable name to avoid shadowing
+ lua's "type" function
+
+This causes a crash when running in a VM because the code tries to
+execute lua's "type()" and ends up executing the local string variable...
+
+Fixes: #303
+---
+ src/scripts/monitors/alsa.lua | 4 ++--
+ 1 file changed, 2 insertions(+), 2 deletions(-)
+
+diff --git a/src/scripts/monitors/alsa.lua b/src/scripts/monitors/alsa.lua
+index 43fab943..38f847f7 100644
+--- a/src/scripts/monitors/alsa.lua
++++ b/src/scripts/monitors/alsa.lua
+@@ -49,7 +49,7 @@ function nonempty(str)
+   return str ~= "" and str or nil
+ end
+ 
+-function createNode(parent, id, type, factory, properties)
++function createNode(parent, id, obj_type, factory, properties)
+   local dev_props = parent.properties
+ 
+   -- set the device id and spa factory name; REQUIRED, do not change
+@@ -199,7 +199,7 @@ function createDevice(parent, id, factory, properties)
+   end
+ end
+ 
+-function prepareDevice(parent, id, type, factory, properties)
++function prepareDevice(parent, id, obj_type, factory, properties)
+   -- ensure the device has an appropriate name
+   local name = "alsa_card." ..
+     (properties["device.name"] or
+-- 
+GitLab
+
-- 
GitLab

