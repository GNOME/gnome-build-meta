From a65ffd61a46631711553ee9d29cc745e8a58cf2d Mon Sep 17 00:00:00 2001
From: Jordan Petridis <jordan@centricular.com>
Date: Mon, 5 Sep 2022 04:55:48 +0300
Subject: [PATCH 1/2] Revert "Update to openh264 2.3.0"

Upstream PR: https://github.com/endlessm/noopenh264/pull/11

This reverts commit 37fc51936111c14779c5c8b77ddbfa7ae2583ccb.
---
 elements/components/noopenh264.bst |  5 ++
 include/repo_branches.yml          |  2 +-
 patches/noopenh264/11.patch        | 81 ++++++++++++++++++++++++++++++
 3 files changed, 87 insertions(+), 1 deletion(-)
 create mode 100644 patches/noopenh264/11.patch

diff --git a/elements/components/noopenh264.bst b/elements/components/noopenh264.bst
index b66046fe6e..90e2feaa64 100644
--- a/elements/components/noopenh264.bst
+++ b/elements/components/noopenh264.bst
@@ -43,6 +43,11 @@ sources:
 - kind: git_tag
   url: github:endlessm/noopenh264.git
   track: master
+  # There is no tag for 2.2.0
+  # This is a tag for 2.3.0 but the patches revert the version back to 2.2.0
+  track-tags: false
   ref: Version_2.3.0-0-g750147f1e5af5cd9f47ffabef996c335b1ba0481
   exclude:
   - Release*
+- kind: patch_queue
+  path: patches/noopenh264
diff --git a/include/repo_branches.yml b/include/repo_branches.yml
index d2cc2d5150..487b52b76b 100644
--- a/include/repo_branches.yml
+++ b/include/repo_branches.yml
@@ -3,4 +3,4 @@
 #
 freedesktop-sdk-flatpak-branch: '22.08'
 freedesktop-sdk-snap-branch: '2208'
-openh264-version: '2.3.0'
+openh264-version: '2.2.0'
diff --git a/patches/noopenh264/11.patch b/patches/noopenh264/11.patch
new file mode 100644
index 0000000000..1fe7bbeb2e
--- /dev/null
+++ b/patches/noopenh264/11.patch
@@ -0,0 +1,81 @@
+From a5435aabdeb4516f249db95b399d6d97f4084d31 Mon Sep 17 00:00:00 2001
+From: Jordan Petridis <jordan@centricular.com>
+Date: Mon, 5 Sep 2022 04:42:55 +0300
+Subject: [PATCH 1/3] Revert "Merge pull request #9 from nanonyme/2.3.0"
+
+This reverts commit 7fbabfb3ccd5170e0d02e4c84bbe3ff694ba23e3, reversing
+changes made to dfe5e4ecc78c4b13b31b8f8c611373a769fe838c.
+---
+ meson.build | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/meson.build b/meson.build
+index 3a7dc05..6996583 100644
+--- a/meson.build
++++ b/meson.build
+@@ -9,7 +9,7 @@ project('noopenh264', ['cpp'],
+ )
+ 
+ major_version = '6'
+-matching_version = '2.3.0'
++matching_version = '2.2.0'
+ 
+ pkgconfig = import('pkgconfig')
+ 
+
+From eee5ae5d4f0c841a057ddefb6c1e22c6b05f68bd Mon Sep 17 00:00:00 2001
+From: Jordan Petridis <jordan@centricular.com>
+Date: Mon, 5 Sep 2022 04:42:29 +0300
+Subject: [PATCH 2/3] Revert "Bump package version to 2.3.0"
+
+This reverts commit 750147f1e5af5cd9f47ffabef996c335b1ba0481.
+---
+ debian/changelog | 6 ------
+ 1 file changed, 6 deletions(-)
+
+diff --git a/debian/changelog b/debian/changelog
+index 13c2c80..14e427b 100644
+--- a/debian/changelog
++++ b/debian/changelog
+@@ -1,9 +1,3 @@
+-noopenh264 (2.3.0) eos; urgency=medium
+-
+-  * Update to match new upstream version.
+-
+- -- Will Thompson <wjt@endlessos.org>  Mon, 01 Aug 2022 18:07:27 +0100
+-
+ noopenh264 (2.1.1-2) eos; urgency=medium
+ 
+   * Revert changes to add plumbing to openh264 flatpak runtime, this is
+
+From d8c760615f2eaff6f592ae786b4b7f64a2b39c41 Mon Sep 17 00:00:00 2001
+From: Jordan Petridis <jordan@centricular.com>
+Date: Mon, 5 Sep 2022 04:43:35 +0300
+Subject: [PATCH 3/3] codec_ver.h: Sync version header for 2.2.0
+
+---
+ codec/api/svc/codec_ver.h | 10 +++++-----
+ 1 file changed, 5 insertions(+), 5 deletions(-)
+
+diff --git a/codec/api/svc/codec_ver.h b/codec/api/svc/codec_ver.h
+index f45ab3f..adc1c3e 100644
+--- a/codec/api/svc/codec_ver.h
++++ b/codec/api/svc/codec_ver.h
+@@ -4,12 +4,12 @@
+ 
+ #include "codec_app_def.h"
+ 
+-static const OpenH264Version g_stCodecVersion  = {2, 1, 1, 2005};
+-static const char* const g_strCodecVer  = "OpenH264 version:2.1.1.2005";
++static const OpenH264Version g_stCodecVersion  = {2, 2, 0, 2201};
++static const char* const g_strCodecVer  = "OpenH264 version:2.2.0.2201";
+ 
+ #define OPENH264_MAJOR (2)
+-#define OPENH264_MINOR (1)
+-#define OPENH264_REVISION (1)
+-#define OPENH264_RESERVED (2005)
++#define OPENH264_MINOR (2)
++#define OPENH264_REVISION (0)
++#define OPENH264_RESERVED (2201)
+ 
+ #endif  // CODEC_VER_H
-- 
GitLab


From 5a3c18086ed9c3196641c066d2f16dfc0854d7d0 Mon Sep 17 00:00:00 2001
From: Jordan Petridis <jordan@centricular.com>
Date: Sat, 3 Sep 2022 23:57:27 +0300
Subject: [PATCH 2/2] gstreamer: Backport patch for the openh264 plugin

https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/2918
---
 patches/gstreamer/2924.patch | 84 ++++++++++++++++++++++++++++++++++++
 1 file changed, 84 insertions(+)
 create mode 100644 patches/gstreamer/2924.patch

diff --git a/patches/gstreamer/2924.patch b/patches/gstreamer/2924.patch
new file mode 100644
index 0000000000..e39650619b
--- /dev/null
+++ b/patches/gstreamer/2924.patch
@@ -0,0 +1,84 @@
+From d2110dfe1d8824c4137c7169f4d560fcf78fa024 Mon Sep 17 00:00:00 2001
+From: Philippe Normand <philn@igalia.com>
+Date: Sat, 20 Aug 2022 16:15:15 +0100
+Subject: [PATCH] openh264: Register debug categories earlier
+
+Otherwise the GST_ERROR message logged in case of ABI mismatch would be done on
+an uninitialized category.
+
+Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/2924>
+---
+ .../ext/openh264/gstopenh264dec.cpp                | 11 +++++------
+ .../ext/openh264/gstopenh264enc.cpp                | 14 +++++++-------
+ 2 files changed, 12 insertions(+), 13 deletions(-)
+
+diff --git a/subprojects/gst-plugins-bad/ext/openh264/gstopenh264dec.cpp b/subprojects/gst-plugins-bad/ext/openh264/gstopenh264dec.cpp
+index e42dc093b70..6d3464628f8 100644
+--- a/subprojects/gst-plugins-bad/ext/openh264/gstopenh264dec.cpp
++++ b/subprojects/gst-plugins-bad/ext/openh264/gstopenh264dec.cpp
+@@ -86,10 +86,7 @@ GST_STATIC_PAD_TEMPLATE ("src",
+ 
+ /* class initialization */
+ 
+-G_DEFINE_TYPE_WITH_CODE (GstOpenh264Dec, gst_openh264dec,
+-    GST_TYPE_VIDEO_DECODER,
+-    GST_DEBUG_CATEGORY_INIT (gst_openh264dec_debug_category, "openh264dec", 0,
+-        "debug category for openh264dec element"));
++G_DEFINE_TYPE (GstOpenh264Dec, gst_openh264dec, GST_TYPE_VIDEO_DECODER);
+ GST_ELEMENT_REGISTER_DEFINE_CUSTOM (openh264dec, openh264dec_element_init);
+ 
+ static void
+@@ -455,10 +452,12 @@ gst_openh264dec_decide_allocation (GstVideoDecoder * decoder, GstQuery * query)
+ static gboolean
+ openh264dec_element_init (GstPlugin * plugin)
+ {
++  GST_DEBUG_CATEGORY_INIT (gst_openh264dec_debug_category, "openh264dec", 0,
++      "debug category for openh264dec element");
+   if (openh264_element_init (plugin))
+     return gst_element_register (plugin, "openh264dec", GST_RANK_MARGINAL,
+         GST_TYPE_OPENH264DEC);
+ 
+- GST_ERROR ("Incorrect library version loaded, expecting %s", g_strCodecVer);
+- return FALSE;
++  GST_ERROR ("Incorrect library version loaded, expecting %s", g_strCodecVer);
++  return FALSE;
+ }
+diff --git a/subprojects/gst-plugins-bad/ext/openh264/gstopenh264enc.cpp b/subprojects/gst-plugins-bad/ext/openh264/gstopenh264enc.cpp
+index 3328d01d99b..00ad6b1d650 100644
+--- a/subprojects/gst-plugins-bad/ext/openh264/gstopenh264enc.cpp
++++ b/subprojects/gst-plugins-bad/ext/openh264/gstopenh264enc.cpp
+@@ -234,10 +234,7 @@ GST_STATIC_PAD_TEMPLATE ("src",
+ /* class initialization */
+ 
+ G_DEFINE_TYPE_WITH_CODE (GstOpenh264Enc, gst_openh264enc,
+-    GST_TYPE_VIDEO_ENCODER,
+-    G_IMPLEMENT_INTERFACE (GST_TYPE_PRESET, NULL);
+-    GST_DEBUG_CATEGORY_INIT (gst_openh264enc_debug_category, "openh264enc", 0,
+-        "debug category for openh264enc element"));
++    GST_TYPE_VIDEO_ENCODER, G_IMPLEMENT_INTERFACE (GST_TYPE_PRESET, NULL));
+ GST_ELEMENT_REGISTER_DEFINE_CUSTOM (openh264enc, openh264enc_element_init);
+ 
+ static void
+@@ -1057,13 +1054,16 @@ gst_openh264enc_finish (GstVideoEncoder * encoder)
+ 
+   return GST_FLOW_OK;
+ }
++
+ static gboolean
+ openh264enc_element_init (GstPlugin * plugin)
+ {
++  GST_DEBUG_CATEGORY_INIT (gst_openh264enc_debug_category, "openh264enc", 0,
++      "debug category for openh264enc element");
+   if (openh264_element_init (plugin))
+     return gst_element_register (plugin, "openh264enc", GST_RANK_MARGINAL,
+-                                 GST_TYPE_OPENH264ENC);
++        GST_TYPE_OPENH264ENC);
+ 
+- GST_ERROR ("Incorrect library version loaded, expecting %s", g_strCodecVer);
+- return FALSE;
++  GST_ERROR ("Incorrect library version loaded, expecting %s", g_strCodecVer);
++  return FALSE;
+ }
+-- 
+GitLab
+
-- 
GitLab

