From c8d3b51070ef2c6b1c030f4064a0b36a3c035932 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marc-Andr=C3=A9=20Lureau?= <marcandre.lureau@redhat.com>
Date: Fri, 1 Jul 2022 12:27:46 +0400
Subject: [PATCH] build-sys: build against phodav-3.0/soup-3.0 if possible
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Prefer libsoup 3.0 over 2.0, when available.

Signed-off-by: Marc-Andr√© Lureau <marcandre.lureau@redhat.com>
---
 meson.build | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index 00aff30e..dd462940 100644
--- a/meson.build
+++ b/meson.build
@@ -184,11 +184,17 @@ endif
 
 # webdav
 spice_gtk_has_phodav = false
-phodav_dep = dependency('libphodav-2.0', required: get_option('webdav'))
-summary_info += {'webdav': phodav_dep.found()}
+phodav_dep = dependency('libphodav-3.0', required: false)
+if not phodav_dep.found()
+  phodav_dep = dependency('libphodav-2.0', required: get_option('webdav'))
+endif
 if phodav_dep.found()
   spice_glib_deps += phodav_dep
-  d = dependency('libsoup-2.4', version : '>= 2.49.91', required: get_option('webdav'))
+  if phodav_dep.name() == 'libphodav-3.0'
+    d = dependency('libsoup-3.0', version : '>= 3.0', required: get_option('webdav'))
+  else
+    d = dependency('libsoup-2.4', version : '>= 2.49.91', required: get_option('webdav'))
+  endif
   if d.found()
     spice_glib_deps += d
     spice_gtk_config_data.set('USE_PHODAV', '1')
@@ -198,6 +204,7 @@ if phodav_dep.found()
     endif
   endif
 endif
+summary_info += {'webdav': spice_gtk_has_phodav}
 
 gstreamer_version = '1.10'
 gstreamer_version_info = '>= @0@'.format(gstreamer_version)
-- 
GitLab

