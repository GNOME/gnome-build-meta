From 284f0e09f165893b79dd63bc259efdcf60c761f6 Mon Sep 17 00:00:00 2001
From: Jordan Petridis <jpetridis@gnome.org>
Date: Tue, 23 Jul 2024 17:22:03 +0200
Subject: [PATCH] Revert "vulkan-icd-loader: Drop patch and use
 EXTRASYSCONFDIR"

This reverts commit ff19d5287da3d8668e1485945a951cfb72ecbe8d.
---
 elements/components/vulkan-icd-loader.bst | 15 +++---
 elements/include/vulkan-stack.yml         |  3 ++
 patches/vulkan/vulkan-libdir-path.patch   | 64 +++++++++++++++++++++++
 3 files changed, 73 insertions(+), 9 deletions(-)
 create mode 100644 patches/vulkan/vulkan-libdir-path.patch

diff --git a/elements/components/vulkan-icd-loader.bst b/elements/components/vulkan-icd-loader.bst
index 3129beda00..5cfc6ed111 100644
--- a/elements/components/vulkan-icd-loader.bst
+++ b/elements/components/vulkan-icd-loader.bst
@@ -4,32 +4,29 @@ build-depends:
 - public-stacks/buildsystem-cmake.bst
 
 depends:
 - bootstrap-import.bst
 - components/vulkan-headers.bst
 - components/xorg-lib-x11.bst
 - components/xorg-lib-xrandr.bst
 - components/wayland.bst
 
 variables:
-  cmake-local: >-
-    -DCMAKE_SKIP_RPATH:BOOL=yes
-    -DCMAKE_INSTALL_SYSCONFDIR:PATH=%{sysconfdir}
-    -DEXTRASYSCONFDIR=%{vulkan-extra-dir}
-    -DBUILD_TESTS=OFF
-    -DBUILD_WSI_XCB_SUPPORT=On
-    -DBUILD_WSI_XLIB_SUPPORT=On
+  cmake-local: |
+    -DCMAKE_SKIP_RPATH:BOOL=yes \
+    -DCMAKE_INSTALL_SYSCONFDIR:PATH=%{sysconfdir} \
+    -DBUILD_TESTS=OFF \
+    -DBUILD_WSI_XCB_SUPPORT=On \
+    -DBUILD_WSI_XLIB_SUPPORT=On \
     -DBUILD_WSI_WAYLAND_SUPPORT=On
 
   command-subdir: vulkan-icd-loader
-  vulkan-extra-dir: |
-     %{libdir}/GL:%{libdir}:%{indep-libdir}/extension/vulkan/share
 
 public:
   bst:
     split-rules:
       devel:
         (>):
         - '%{libdir}/libvulkan.so'
 
 (@):
 - elements/include/vulkan-stack.yml
diff --git a/elements/include/vulkan-stack.yml b/elements/include/vulkan-stack.yml
index b3bb37c4a2..eb08853840 100644
--- a/elements/include/vulkan-stack.yml
+++ b/elements/include/vulkan-stack.yml
@@ -30,20 +30,23 @@ sources:
 - kind: git_repo
   url: github:KhronosGroup/glslang.git
   directory: glslang
   track: vulkan-sdk-*
   ref: vulkan-sdk-1.3.283.0-0-ge8dd0b6903b34f1879520b444634c75ea2deedf5
 - kind: git_repo
   url: github:KhronosGroup/Vulkan-Loader.git
   directory: vulkan-icd-loader
   track: vulkan-sdk-*
   ref: vulkan-sdk-1.3.283.0-0-g720be5198aad4696381d2e3eeadc131c9f56bdc6
+- kind: patch
+  directory: vulkan-icd-loader
+  path: patches/vulkan/vulkan-libdir-path.patch
 - kind: git_repo
   url: github:KhronosGroup/Vulkan-Utility-Libraries.git
   directory: vulkan-utility-libraries
   track: vulkan-sdk-*
   ref: vulkan-sdk-1.3.283.0-0-gad7f699a7b2b5deb66eb3de19f24aa33597ed65b
 - kind: git_repo
   url: github:zeux/volk.git
   directory: volk
   track: vulkan-sdk-*
   ref: vulkan-sdk-1.3.283.0-0-g3a8068a57417940cf2bf9d837a7bb60d015ca2f1
diff --git a/patches/vulkan/vulkan-libdir-path.patch b/patches/vulkan/vulkan-libdir-path.patch
new file mode 100644
index 0000000000..ce45feb2d4
--- /dev/null
+++ b/patches/vulkan/vulkan-libdir-path.patch
@@ -0,0 +1,64 @@
+diff --git a/CMakeLists.txt b/CMakeLists.txt
+index d6afdc7c5..3d061f120 100644
+--- a/CMakeLists.txt
++++ b/CMakeLists.txt
+@@ -287,6 +287,14 @@ if(CMAKE_COMPILER_IS_GNUCC OR CMAKE_C_COMPILER_ID MATCHES "Clang")
+         target_compile_options(loader_common_options INTERFACE -fvisibility=hidden)
+     endif()
+ 
++    # NOTE: freedesktop search paths
++    # appropriate drivers
++    add_definitions(-DVULKAN_LIB_DIR_GL="${CMAKE_INSTALL_FULL_LIBDIR}/GL")
++    # opensource drivers
++    add_definitions(-DVULKAN_LIB_DIR="${CMAKE_INSTALL_FULL_LIBDIR}")
++    # vulkan extension
++    add_definitions(-DVULKAN_FDO_SDK_EXT_DIR="${CMAKE_INSTALL_PREFIX}/lib/extensions/vulkan/share")
++
+     target_compile_options(loader_common_options INTERFACE -Wpointer-arith)
+ 
+     # Clang (and not gcc) warns about redefining a typedef with the same types, so disable that warning. Note that it will still
+diff --git a/loader/loader.c b/loader/loader.c
+index 86c283f48..c1a823047 100644
+--- a/loader/loader.c
++++ b/loader/loader.c
+@@ -3054,6 +3054,20 @@ static VkResult read_data_files_in_search_paths(const struct loader_instance *in
+ #if defined(EXTRASYSCONFDIR)
+             search_path_size += determine_data_file_path_size(EXTRASYSCONFDIR, rel_size);
+ #endif
++
++/*freedesktop  appropriate drivers */
++#if defined(VULKAN_LIB_DIR_GL)
++            search_path_size += determine_data_file_path_size(VULKAN_LIB_DIR_GL, rel_size);
++#endif
++/* freedesktop opensource drivers */
++#if defined(VULKAN_LIB_DIR)
++            search_path_size += determine_data_file_path_size(VULKAN_LIB_DIR, rel_size);
++#endif
++/* freedesktop vulkan extensions */
++#if defined(VULKAN_FDO_SDK_EXT_DIR)
++            search_path_size += determine_data_file_path_size(VULKAN_FDO_SDK_EXT_DIR, rel_size);
++#endif
++
+             // Only add the home folders if defined
+             if (NULL != home_data_dir) {
+                 search_path_size += determine_data_file_path_size(home_data_dir, rel_size);
+@@ -3120,6 +3134,19 @@ static VkResult read_data_files_in_search_paths(const struct loader_instance *in
+             copy_data_file_info(EXTRASYSCONFDIR, relative_location, rel_size, &cur_path_ptr);
+ #endif
+ 
++/*freedesktop  appropriate drivers */
++#if defined(VULKAN_LIB_DIR_GL)
++            copy_data_file_info(VULKAN_LIB_DIR_GL, relative_location, rel_size, &cur_path_ptr);
++#endif
++/* freedesktop opensource drivers */
++#if defined(VULKAN_LIB_DIR)
++            copy_data_file_info(VULKAN_LIB_DIR, relative_location, rel_size, &cur_path_ptr);
++#endif
++/* freedesktop vulkan extensions */
++#if defined(VULKAN_FDO_SDK_EXT_DIR)
++            copy_data_file_info(VULKAN_FDO_SDK_EXT_DIR, relative_location, rel_size, &cur_path_ptr);
++#endif
++
+             // Only add the home folders if not NULL
+             if (NULL != home_data_dir) {
+                 copy_data_file_info(home_data_dir, relative_location, rel_size, &cur_path_ptr);
-- 
2.45.2

